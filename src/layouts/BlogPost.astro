---
import type { CollectionEntry } from "astro:content";
import FormattedDate from "../components/FormattedDate.astro";

type Props = CollectionEntry<"blog">["data"] & { headings: { depth: number; slug: string; text: string }[] };

const { title, description, pubDate, updatedDate, heroImage, headings = [] } = Astro.props;
---

<article class="my-12 relative flex lg:gap-12 items-start">
    <!-- Table of Contents (Sticky Sidebar for Desktop) -->
    {headings.length > 0 && (
        <aside class="hidden lg:block sticky top-24 min-w-[250px] max-w-[250px] bg-gray-900/40 p-5 rounded-xl border border-gray-800">
            <h2 class="text-sm font-bold uppercase tracking-wider text-pink-500 mb-4">On this page</h2>
            <nav class="flex flex-col gap-2.5">
                {headings.map((heading) => (
                    <a 
                        href={`#${heading.slug}`}
                        class={`
                            toc-link text-sm text-gray-400 hover:text-white transition-colors block
                            ${heading.depth === 3 ? 'pl-4 border-l border-gray-800 hover:border-pink-500/50' : ''}
                            data-[active=true]:text-pink-400 data-[active=true]:font-medium
                            ${heading.depth === 3 ? 'data-[active=true]:border-pink-500' : ''}
                        `}
                    >
                        {heading.text}
                    </a>
                ))}
            </nav>
        </aside>
    )}

    <!-- Main Content -->
    <div class="flex-1 w-full min-w-0">
        <div class="mb-12 rounded-md overflow-hidden shadow-md shadow-pink-500">
            {heroImage && <img class="w-full h-[420px] object-cover object-center" src={heroImage} alt="" />}
        </div>
        
        <div class="prose prose-pink prose-invert max-w-none prose-headings:scroll-mt-24 prose-kbd:bg-pink-800">
            <div>
                <div class="date">
                    <FormattedDate date={pubDate} />
                    {updatedDate && (
                        <div class="last-updated-on">
                            Last updated on <FormattedDate date={updatedDate} />
                        </div>
                    )}
                </div>
                <h1>{title}</h1>
                <hr />
            </div>
            <slot></slot>
        </div>
    </div>
</article>

<script>
    /**
     * Highlights the active section in the Table of Contents based on scroll position.
     * Uses IntersectionObserver for high performance.
     */
    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting) {
                const id = entry.target.getAttribute('id');
                if (!id) return;

                // Remove active state from all links
                document.querySelectorAll('.toc-link').forEach((link) => {
                    link.setAttribute('data-active', 'false');
                });

                // Add active state to the current link
                const activeLink = document.querySelector(`.toc-link[href="#${id}"]`);
                if (activeLink) {
                    activeLink.setAttribute('data-active', 'true');
                }
            }
        });
    }, {
        rootMargin: '-10% 0px -80% 0px' // Trigger when the heading is near the top of the screen
    });

    // Observe all headings (h1, h2, h3, etc.) in the article
    document.querySelectorAll('article h1, article h2, article h3, article h4').forEach((heading) => {
        observer.observe(heading);
    });
</script>
